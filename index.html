<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´å¶æ–¯å…¬å¼ï¼šäº¤äº’é€»è¾‘ä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --bg: #f4f6f9;
            --panel: #ffffff;
            --border: #e2e8f0;
            --text: #2d3748;
            --primary: #3182ce;
            /* è¯­ä¹‰è‰² */
            --c-tp: #f56565; /* çº¢ï¼šçœŸé˜³ */
            --c-fp: #38b2ac; /* é’ï¼šå‡é˜³ */
            --c-tn: #cbd5e0; /* ç° */
            --c-fn: #2d3748; /* é»‘ */
        }

        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--text);
            font-family: -apple-system, "Microsoft YaHei", "Times New Roman", sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* é¡¶éƒ¨ Header */
        header {
            flex: 0 0 60px; background: var(--panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 10;
        }
        .header-left h1 { margin: 0; font-size: 1.2rem; color: #1a202c; font-weight: 800; font-family: sans-serif; }
        
        .controls { display: flex; gap: 20px; align-items: center; font-family: sans-serif; }
        
        /* åœºæ™¯ä¿¡æ¯åŒº - åŠ¨æ€å˜åŒ–çš„æ–‡æœ¬ */
        #scene-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-right: 15px;
            padding-right: 20px;
            border-right: 1px solid #e2e8f0;
            min-width: 160px;
            text-align: right;
        }
        #scene-title { font-size: 0.95rem; font-weight: bold; color: var(--primary); margin-bottom: 2px; transition: color 0.3s; }
        #scene-desc { font-size: 0.75rem; color: #718096; white-space: nowrap; }

        .slider-group { width: 130px; }
        .sl-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: #718096; margin-bottom: 3px; font-weight: 600; }
        input[type=range] { width: 100%; cursor: pointer; }
        
        .btn-rand {
            background: #3182ce; color: white; border: none; padding: 6px 14px; border-radius: 20px; 
            font-size: 0.85rem; font-weight: bold; cursor: pointer; transition: 0.2s; font-family: sans-serif;
            white-space: nowrap;
        }
        .btn-rand:hover { background: #2c5282; }

        /* ä¸»å¸ƒå±€ */
        main { flex: 1; display: flex; gap: 12px; padding: 12px; overflow: hidden; }

        /* å·¦ä¾§ */
        #visual-panel {
            flex: 6; background: var(--panel); border-radius: 8px; border: 1px solid var(--border);
            display: flex; flex-direction: column; position: relative;
        }
        
        /* --- ä¿®æ”¹ç‚¹ï¼šå›¾ä¾‹æ ·å¼è°ƒæ•´ --- */
        .legend {
            position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.95);
            padding: 10px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.75rem; z-index: 5;
            font-family: sans-serif;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 4px; /* å¢åŠ è¡Œé—´è· */
        }
        .legend-row { display: flex; align-items: center; justify-content: space-between; min-width: 120px; }
        .legend-label { display: flex; align-items: center; }
        .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        /* ------------------------- */

        .btn-sort { 
            position: absolute; top: 10px; right: 10px; z-index: 5; cursor: pointer; padding: 6px 12px; 
            background: white; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.8rem; font-family: sans-serif;
        }
        
        #particle-canvas { flex: 1; width: 100%; height: 100%; }

        /* å³ä¾§ */
        #logic-panel { flex: 4; display: flex; flex-direction: column; gap: 12px; min-width: 320px; overflow-y: auto; padding-right: 5px; }
        
        .card { 
            background: var(--panel); border-radius: 8px; border: 1px solid var(--border); padding: 12px; 
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .card h3 { margin: 0 0 10px 0; font-size: 0.9rem; color: #4a5568; border-bottom: 2px solid #edf2f7; padding-bottom: 5px; font-family: sans-serif; }

        .context-box { font-size: 0.85rem; color: #4a5568; line-height: 1.5; font-family: sans-serif; }
        .def-row { display: flex; align-items: baseline; margin-top: 4px; }
        .def-key { font-weight: bold; width: 80px; color: var(--primary); font-family: "Times New Roman", serif; }

        .formula-card { background: #fffcf5; border-left: 4px solid #ed8936; }
        .math-row {
            display: flex; align-items: center; margin-bottom: 8px; font-size: 0.95rem;
            font-family: "Times New Roman", serif; color: #2d3748;
        }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 5px; font-size: 0.9em; }
        .frac-num { border-bottom: 1px solid #000; padding: 0 5px 2px; }
        .frac-den { padding: 2px 5px 0; }
        .hl-red { color: var(--c-tp); font-weight: bold; }
        .hl-cyan { color: var(--c-fp); font-weight: bold; }
        .hl-bar { text-decoration: overline; }

        .prob-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 5px; }
        .prob-col h4 { margin: 0 0 8px 0; font-size: 0.8rem; color: #718096; border-bottom: 1px dashed #d69e2e; }
        .prob-row {
            display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9rem;
            font-family: "Times New Roman", serif;
        }
        .prob-val { font-weight: bold; color: #2b6cb0; font-family: monospace; }
        
        .native-bar-chart { margin-top: 10px; font-family: sans-serif; }
        .bar-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.75rem; }
        .bar-lbl { width: 50px; text-align: right; margin-right: 8px; color: #718096; }
        .bar-bg { flex: 1; height: 18px; background: #edf2f7; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-val { height: 100%; color: white; line-height: 18px; text-align: center; font-size: 0.7rem; white-space: nowrap; }

        .conclusion { margin-top: 10px; background: #ebf8ff; padding: 10px; border-radius: 6px; text-align: center; }
        .result-big { font-size: 1.6rem; font-weight: 800; color: #e53e3e; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>è´å¶æ–¯å…¬å¼æœºç† <span style="font-weight:normal; font-size:0.8em; color:#718096">| åŸç†æ•™å­¦</span></h1>
    </div>
    
    <div class="controls">
        <div id="scene-info">
            <span id="scene-title">åŠ è½½ä¸­...</span>
            <span id="scene-desc">...</span>
        </div>

        <button id="btn-rand" class="btn-rand">ğŸ² éšæœºæ¡ˆä¾‹</button>
        
        <div class="slider-group">
            <div class="sl-label"><span>å…ˆéªŒ P(C)</span><span id="txt-pC">0.5%</span></div>
            <input type="range" id="sl-pC" min="0.1" max="50" step="0.1" value="0.5">
        </div>
        <div class="slider-group">
            <div class="sl-label"><span>çµæ•åº¦ P(A|C)</span><span id="txt-sens">95%</span></div>
            <input type="range" id="sl-sens" min="50" max="99.9" step="0.1" value="95">
        </div>
        <div class="slider-group">
            <div class="sl-label"><span>è¯¯è¯Šç‡ P(A|CÌ…)</span><span id="txt-fpr">4%</span></div>
            <input type="range" id="sl-fpr" min="0.1" max="20" step="0.1" value="4">
        </div>
    </div>
</header>

<main>
    <!-- å·¦ä¾§ï¼šç²’å­å¯è§†åŒ– -->
    <div id="visual-panel">
        <!-- ğŸ”´ æ›´æ–°åçš„å›¾ä¾‹ -->
        <div class="legend">
            <div class="legend-row" style="color:#2d3748">
                <span class="legend-label"><span class="dot" style="background:var(--c-tp)"></span>TP (çœŸé˜³æ€§)</span>
                <b id="val-tp"></b>
            </div>
            <div class="legend-row" style="color:#2d3748">
                <span class="legend-label"><span class="dot" style="background:var(--c-fp)"></span>FP (å‡é˜³æ€§)</span>
                <b id="val-fp"></b>
            </div>
            <div class="legend-row" style="color:#2d3748">
                <span class="legend-label"><span class="dot" style="background:var(--c-fn)"></span>FN (æ¼è¯Š)</span>
                <b id="val-fn"></b> <!-- æ–°å¢è®¡æ•°ID -->
            </div>
            <div class="legend-row" style="color:#a0aec0">
                <span class="legend-label"><span class="dot" style="background:var(--c-tn)"></span>TN (çœŸé˜´æ€§)</span>
                <!-- TN æ•°é‡å¾€å¾€å¤ªå¤§ï¼Œé€šå¸¸çœç•¥ï¼Œæˆ–è€…ä½ å¯ä»¥åŠ ä¸Š -->
            </div>
        </div>

        <button id="btn-sort" class="btn-sort">ğŸ” æ•£ä¹±/æ’åº</button>
        <canvas id="particle-canvas"></canvas>
    </div>

    <!-- å³ä¾§ï¼šæ•™å­¦é€»è¾‘ -->
    <div id="logic-panel">
        <!-- 1. é—®é¢˜èƒŒæ™¯ -->
        <div class="card" style="background:#f7fafc; border-color:#90cdf4;">
            <h3>ğŸ“– èƒŒæ™¯ï¼šåŒ»ç–—ç­›æŸ¥æ¨¡å‹</h3>
            <div class="context-box">
                <div class="def-row"><span class="def-key">äº‹ä»¶ C</span> <span class="def-val">æ‚£ç—… (Cancer)</span></div>
                <div class="def-row"><span class="def-key">äº‹ä»¶ A</span> <span class="def-val">æ£€æµ‹é˜³æ€§ (Positive)</span></div>
            </div>
        </div>

        <!-- 2. å…¬å¼å®šä¹‰ -->
        <div class="card formula-card">
            <h3>ğŸ“ æ¦‚ç‡è®ºå…¬å¼æ¨å¯¼</h3>
            
            <div class="math-row">
                <span class="math-label">1. å…ˆéªŒæ¦‚ç‡: &nbsp;</span>
                <span>P(C) = </span> <span id="math-pc-val" style="margin-left:5px; font-weight:bold;">0.5%</span>
            </div>

            <div class="math-row">
                <span class="math-label">2. å…¨æ¦‚ç‡ P(A):</span>
            </div>
            <div class="math-row" style="justify-content: center; background:#fff; padding:5px; border-radius:4px;">
                <span>P(A) = </span>
                <span class="hl-red">P(A|C)P(C)</span> 
                <span>&nbsp;+&nbsp;</span>
                <span class="hl-cyan">P(A|<span class="hl-bar">C</span>)P(<span class="hl-bar">C</span>)</span>
            </div>

            <div class="math-row" style="margin-top:10px;">
                <span class="math-label">3. è´å¶æ–¯åéªŒ P(C|A):</span>
            </div>
            <div class="math-row" style="justify-content: center;">
                <div class="fraction">
                    <div class="frac-num"><span class="hl-red">çœŸé˜³æ€§ P(AC)</span></div>
                    <div class="frac-den">
                        <span class="hl-red">çœŸé˜³</span> + <span class="hl-cyan">å‡é˜³</span>
                    </div>
                </div>
                <span>&nbsp;=&nbsp;</span>
                <div class="fraction">
                    <div class="frac-num"><span class="hl-red">P(A|C) P(C)</span></div>
                    <div class="frac-den"><span>P(A)</span></div>
                </div>
            </div>
        </div>

        <!-- 3. æ•°å€¼éªŒè¯ -->
        <div class="card" style="flex:1">
            <h3>ğŸ§® ç†è®º vs è¯•éªŒéªŒè¯</h3>
            <div class="prob-grid">
                <!-- ç†è®ºå€¼ -->
                <div class="prob-col" style="border-right:1px dashed #e2e8f0; padding-right:10px;">
                    <h4>ç†è®ºè®¾å®šå€¼</h4>
                    <div class="prob-row"><span>P(C)</span><span id="th-pc">0.0050</span></div>
                    <div class="prob-row"><span>P(A)</span><span id="th-pa" style="color:#2d3748">0.0445</span></div>
                    <div class="prob-row" style="margin-top:5px; border-top:1px solid #eee;">
                        <span style="font-weight:bold">P(C|A)</span><span class="prob-val hl-red" id="th-pca">0.1066</span>
                    </div>
                </div>
                <!-- è¯•éªŒå€¼ -->
                <div class="prob-col" style="padding-left:10px;">
                    <h4>è¯•éªŒç»Ÿè®¡ (N=1w)</h4>
                    <div class="prob-row"><span>P(C)</span><span id="ex-pc">0.0051</span></div>
                    <div class="prob-row"><span>P(A)</span><span id="ex-pa" style="color:#2d3748">0.0442</span></div>
                    <div class="prob-row" style="margin-top:5px; border-top:1px solid #eee;">
                        <span style="font-weight:bold">P(C|A)</span><span class="prob-val hl-red" id="ex-pca">0.1059</span>
                    </div>
                </div>
            </div>

            <!-- å¯è§†åŒ–æ¡ -->
            <div class="native-bar-chart">
                <div style="font-size:0.75rem; color:#718096; margin-bottom:5px;">æ€»é˜³æ€§ P(A) çš„å†…éƒ¨æ„æˆ:</div>
                <div class="bar-row">
                    <div class="bar-lbl">çœŸé˜³</div>
                    <div class="bar-bg">
                        <div class="bar-val" id="bar-tp" style="background:var(--c-tp);"></div>
                    </div>
                </div>
                <div class="bar-row">
                    <div class="bar-lbl">å‡é˜³</div>
                    <div class="bar-bg">
                        <div class="bar-val" id="bar-fp" style="background:var(--c-fp);"></div>
                    </div>
                </div>
                <div class="conclusion">
                    <span style="font-size:0.8rem; color:#4a5568">è´å¶æ–¯æ¨æ–­ç»“è®º (P(C|A)):</span><br>
                    <span class="result-big" id="val-final">--%</span>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
const app = {
    totalN: 10000,
    particles: [],
    isSorted: false,
    
    // åœºæ™¯æ•°æ®
    scenes: [
        { name:"ç½•è§ç—…ç­›æŸ¥", desc:"å‘ç—…ç‡æä½ï¼Œè¯¯è¯Šé€ æˆæå¤§å¹²æ‰°", p:[0.1, 0.8], s:[95, 99], f:[2, 5] },
        { name:"ç²¾å¯†ä»ªå™¨æ£€æµ‹", desc:"è¯¯è¯Šç‡æä½(<0.5%)ï¼Œç»“æœé«˜åº¦å¯ä¿¡", p:[0.2, 1.0], s:[99, 99.9], f:[0.1, 0.5] },
        { name:"æµè¡Œç—…çˆ†å‘", desc:"å‘ç—…ç‡å‡é«˜ï¼Œæ£€æµ‹ç»“æœæ›´åŠ å¯ä¿¡", p:[10, 15], s:[90, 95], f:[3, 8] },
        { name: "ç²—ç•¥è¯•çº¸", desc: "é«˜è¯¯è¯Šç‡ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸å¯ç¡®è¯Š", p:[1, 3], s:[70, 80], f:[10, 15] }
    ],

    dom: {},

    init() {
        this.dom = {
            pC: document.getElementById('sl-pC'),
            sens: document.getElementById('sl-sens'),
            fpr: document.getElementById('sl-fpr'),
            pCanvas: document.getElementById('particle-canvas'),
            sTitle: document.getElementById('scene-title'),
            sDesc: document.getElementById('scene-desc')
        };

        // ç›‘å¬æ»‘å—ï¼šè§¦å‘æ‰‹åŠ¨æ¨¡å¼æ›´æ–°
        [this.dom.pC, this.dom.sens, this.dom.fpr].forEach(el => 
            el.addEventListener('input', () => this.handleManualUpdate())
        );

        document.getElementById('btn-rand').addEventListener('click', () => this.randomScenario());
        document.getElementById('btn-sort').addEventListener('click', () => this.toggleSort());

        this.resize();
        this.initParticles();
        window.addEventListener('resize', () => { this.resize(); this.recalcTargets(); });

        this.randomScenario();
        this.loop();
    },

    resize() {
        const c = this.dom.pCanvas;
        const r = c.parentElement.getBoundingClientRect();
        if(r.width>0) { c.width = r.width; c.height = r.height; this.width=r.width; this.height=r.height; }
    },

    // éšæœºæ¡ˆä¾‹ï¼šæ›´æ–°æ ‡é¢˜ä¸ºæ¡ˆä¾‹å
    randomScenario() {
        const s = this.scenes[Math.floor(Math.random() * this.scenes.length)];
        const rnd = (range) => (Math.random() * (range[1] - range[0]) + range[0]).toFixed(1);
        
        this.dom.pC.value = rnd(s.p); 
        this.dom.sens.value = rnd(s.s); 
        this.dom.fpr.value = rnd(s.f);
        
        // è®¾ç½®æ¡ˆä¾‹æ ‡é¢˜
        this.dom.sTitle.innerText = s.name;
        this.dom.sDesc.innerText = s.desc;
        this.dom.sTitle.style.color = "#3182ce"; // è“è‰²
        
        this.update(true);
    },

    // æ‰‹åŠ¨è°ƒæ•´ï¼šæ›´æ–°æ ‡é¢˜ä¸ºè‡ªå®šä¹‰
    handleManualUpdate() {
        this.dom.sTitle.innerText = "è‡ªå®šä¹‰æ¢ç©¶";
        this.dom.sDesc.innerText = "å½“å‰ä¸ºæ‰‹åŠ¨è®¾å®šå‚æ•°";
        this.dom.sTitle.style.color = "#d69e2e"; // æ©™è‰²ï¼Œæç¤ºå·²æ”¹å˜
        this.update(true);
    },

    initParticles() {
        this.particles = new Float32Array(this.totalN * 5); 
        for(let i=0; i<this.totalN; i++) {
            const off = i*5;
            this.particles[off] = Math.random() * (this.width||500);
            this.particles[off+1] = Math.random() * (this.height||500);
            this.particles[off+4] = 2; 
        }
    },

    update() {
        const pC = parseFloat(this.dom.pC.value) / 100;
        const sens = parseFloat(this.dom.sens.value) / 100;
        const fpr = parseFloat(this.dom.fpr.value) / 100;

        document.getElementById('txt-pC').innerText = (pC*100).toFixed(1) + "%";
        document.getElementById('txt-sens').innerText = (sens*100).toFixed(1) + "%";
        document.getElementById('txt-fpr').innerText = (fpr*100).toFixed(1) + "%";
        document.getElementById('math-pc-val').innerText = (pC*100).toFixed(2) + "%";

        // ç†è®ºè®¡ç®—
        const t_pa = (pC * sens) + ((1-pC) * fpr);
        const t_pca = t_pa > 0 ? (pC * sens) / t_pa : 0;

        document.getElementById('th-pc').innerText = pC.toFixed(4);
        document.getElementById('th-pa').innerText = t_pa.toFixed(4);
        document.getElementById('th-pca').innerText = t_pca.toFixed(4);

        // è¯•éªŒæ¨¡æ‹Ÿ
        const nSick = Math.round(this.totalN * pC);
        const nHealthy = this.totalN - nSick;
        const nTP = Math.round(nSick * sens);
        const nFN = nSick - nTP;
        const nFP = Math.round(nHealthy * fpr);
        const nTN = nHealthy - nFP;

        const e_pc = nSick / this.totalN;
        const e_pa = (nTP+nFP) / this.totalN;
        const e_pca = (nTP+nFP)>0 ? nTP/(nTP+nFP) : 0;

        document.getElementById('ex-pc').innerText = e_pc.toFixed(4);
        document.getElementById('ex-pa').innerText = e_pa.toFixed(4);
        document.getElementById('ex-pca').innerText = e_pca.toFixed(4);

        document.getElementById('val-final').innerText = (e_pca*100).toFixed(2) + "%";
        document.getElementById('val-tp').innerText = nTP;
        document.getElementById('val-fp').innerText = nFP;
        // ğŸŸ¢ æ–°å¢ï¼šæ›´æ–° FN çš„æ•°é‡
        document.getElementById('val-fn').innerText = nFN;

        // æ¡å½¢å›¾æ›´æ–°
        const totalPos = Math.max(nTP + nFP, 1);
        const wTP = (nTP / totalPos * 100);
        const wFP = (nFP / totalPos * 100);
        document.getElementById('bar-tp').style.width = wTP + "%";
        document.getElementById('bar-tp').innerText = wTP > 12 ? (nTP+"çœŸ") : "";
        document.getElementById('bar-fp').style.width = wFP + "%";
        document.getElementById('bar-fp').innerText = wFP > 12 ? (nFP+"å‡") : "";

        let idx = 0;
        const setType = (n, t) => { for(let i=0; i<n; i++) if(idx<this.totalN) this.particles[idx++ * 5 + 4] = t; };
        setType(nTP, 0); setType(nFP, 1); setType(nFN, 3); setType(nTN, 2);
        while(idx < this.totalN) this.particles[idx++ * 5 + 4] = 2;

        this.recalcTargets();
    },

    recalcTargets() {
        const w = this.width; const h = this.height;
        if(!w) return;
        const cx = w/2; const cy = h/2;
        
        if(!this.isSorted) {
            for(let i=0; i<this.totalN; i++) {
                const off = i*5;
                this.particles[off+2] = Math.random() * w;
                this.particles[off+3] = Math.random() * h;
            }
        } else {
            let iTP=0, iFP=0;
            // æ’åºæ¨¡å¼ï¼šTP å·¦ï¼ŒFP å³
            for(let i=0; i<this.totalN; i++) {
                const off = i*5;
                const type = this.particles[off+4];
                if(type === 0) { // TP
                    const c = iTP % 20; const r = Math.floor(iTP/20);
                    this.particles[off+2] = cx - 15 - (c*3.5);
                    this.particles[off+3] = cy - 50 + (r*3.5); iTP++;
                } else if(type === 1) { // FP
                    const c = iFP % 20; const r = Math.floor(iFP/20);
                    this.particles[off+2] = cx + 15 + (c*3.5);
                    this.particles[off+3] = cy - 50 + (r*3.5); iFP++;
                } else { // Others
                    const cols = Math.floor(w/3.5);
                    this.particles[off+2] = (i % cols) * 3.5;
                    this.particles[off+3] = h - 5 - (Math.floor(i/cols)*3.5);
                }
            }
        }
    },

    toggleSort() { this.isSorted = !this.isSorted; this.recalcTargets(); },

    loop() {
        const ctx = this.dom.pCanvas.getContext('2d');
        const colors = ['#f56565', '#38b2ac', '#cbd5e0', '#2d3748'];
        ctx.clearRect(0, 0, this.width, this.height);

        for(let i=0; i<this.totalN; i++) {
            const off = i*5;
            let x = this.particles[off];
            let y = this.particles[off+1];
            const tx = this.particles[off+2];
            const ty = this.particles[off+3];
            const type = this.particles[off+4];

            if(Math.abs(tx-x)>0.1 || Math.abs(ty-y)>0.1) {
                x += (tx-x)*0.1; y += (ty-y)*0.1;
                this.particles[off] = x; this.particles[off+1] = y;
            }
            
            ctx.fillStyle = colors[type];
            ctx.beginPath(); 
            ctx.arc(x, y, (type<2?2.5:1.5), 0, 6.28); 
            ctx.fill();
        }
        requestAnimationFrame(() => this.loop());
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
