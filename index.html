<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´å¶æ–¯å¯è§†åŒ–ï¼šç¨³å®šéšæœºç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #fff;
            --true-neg: #cbd5e0; 
            --false-pos: #4fd1c5; /* å¹²æ‰°é¡¹ï¼šé’è‰² */
            --true-pos: #f56565;  /* ç›®æ ‡é¡¹ï¼šçº¢è‰² */
            --false-neg: #2d3748;
            --primary: #3182ce;
        }

        body { font-family: "Microsoft YaHei", -apple-system, sans-serif; margin: 0; padding: 0; background: var(--bg-color); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: #fff; padding: 0 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; height: 65px; flex-shrink: 0; }
        .header-left h1 { margin: 0; font-size: 1.2rem; color: #2d3748; font-weight: 800; }
        .header-left small { color: #718096; font-size: 0.8rem; }
        
        .controls { display: flex; gap: 30px; align-items: center; }
        .slider-group { display: flex; flex-direction: column; width: 160px; position: relative; }
        .slider-group label { font-size: 0.75rem; color: #718096; font-weight: 600; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .slider-group input { cursor: pointer; height: 4px; background: #e2e8f0; border-radius: 2px; -webkit-appearance: none; }
        .slider-group input::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -5px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .slider-group input::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }

        /* éšæœºæŒ‰é’® */
        .btn-random {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease; display: flex; align-items: center; gap: 5px;
        }
        .btn-random:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }

        /* åœºæ™¯æç¤ºæ¡ */
        #scenario-toast {
            position: absolute; top: 75px; left: 50%; transform: translateX(-50%);
            background: #2d3748; color: #fff; padding: 10px 20px; border-radius: 30px;
            font-size: 0.85rem; opacity: 0; pointer-events: none; transition: all 0.4s;
            z-index: 99; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;
        }

        /* ä¸»å¸ƒå±€ */
        .main-container { flex: 1; display: flex; gap: 12px; padding: 12px; height: calc(100vh - 65px); box-sizing: border-box; }

        /* å·¦ä¾§ */
        .visual-panel { flex: 2; background: var(--panel-bg); border-radius: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; position: relative; overflow: hidden; min-width: 0; }
        .canvas-wrapper { flex: 1; width: 100%; height: 100%; cursor: crosshair; }
        
        .legend-box { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); padding: 12px; border-radius: 8px; border: 1px solid #edf2f7; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-size: 13px; z-index: 10; width: 140px; }
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }

        .btn-view { position: absolute; top: 15px; right: 15px; background: white; border: 1px solid #cbd5e0; color: #4a5568; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 10;}

        /* å³ä¾§ */
        .stats-panel { flex: 1; display: flex; flex-direction: column; gap: 12px; min-width: 320px; max-width: 420px; }
        
        .card { flex: 1; background: var(--panel-bg); border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; position: relative; min-height: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card h3 { font-size: 0.9rem; font-weight: 700; color: #4a5568; margin: 0 0 10px 0; border-left: 3px solid var(--primary); padding-left: 8px; }
        
        /* ç¡®ä¿å›¾è¡¨å®¹å™¨æœ‰é«˜åº¦ */
        .chart-wrapper { flex: 1; position: relative; width: 100%; min-height: 150px; overflow: hidden; }
        
        /* åŠ è½½å¤±è´¥æç¤º */
        .chart-error { position: absolute; top:0; left:0; right:0; bottom:0; display: flex; align-items: center; justify-content: center; text-align: center; color: #e53e3e; font-size: 0.85rem; background: #fff5f5; border-radius: 8px; padding: 20px; z-index: 20; }
        
        .result-box {
            text-align: center; background: #fff5f5; border: 1px solid #fed7d7; border-radius: 8px;
            padding: 10px; margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        .res-ratio { font-size: 0.8rem; color: #744210; background: #fefcbf; padding: 4px 8px; border-radius: 4px; }
        .res-prob { display: flex; flex-direction: column; }
        .res-val { font-size: 1.8rem; font-weight: 800; color: #e53e3e; line-height: 1; }
        .res-label { font-size: 0.75rem; color: #718096; margin-top: 4px; }
        
        #error-global { position: fixed; bottom: 20px; right: 20px; background: #e53e3e; color: white; padding: 15px; border-radius: 8px; display: none; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
    <!-- å…³é”®ä¿®å¤ï¼šæ›´æ¢ä¸º Staticfile CDN (ä¸ƒç‰›äº‘)ï¼Œå›½å†…éå¸¸ç¨³å®š -->
    <script src="https://cdn.staticfile.org/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>

<header>
    <div class="header-left">
        <h1>è´å¶æ–¯å…¬å¼å¯è§†åŒ–</h1>
        <small>N=10,000 ç²’å­å®æ—¶æ¨¡æ‹Ÿ</small>
    </div>
    
    <div id="scenario-toast">å½“å‰åœºæ™¯ï¼šéšæœºåŠ è½½ä¸­...</div>

    <div class="controls">
        <button class="btn-random" onclick="app.randomScenario()">
            <span>ğŸ²</span> éšæœºæ¡ˆä¾‹
        </button>

        <div class="slider-group">
            <label><span>å‘ç—…ç‡ P(C)</span> <b id="val-pC">0.5%</b></label>
            <input type="range" id="sl-pC" min="0.1" max="50" step="0.1" value="0.5" oninput="app.manualUpdate()">
        </div>
        <div class="slider-group">
            <label><span>çµæ•åº¦ P(A|C)</span> <b id="val-sens">95%</b></label>
            <input type="range" id="sl-sens" min="50" max="99.9" step="0.1" value="95" oninput="app.manualUpdate()">
        </div>
        <div class="slider-group">
            <label><span>è¯¯è¯Šç‡ P(A|CÌ…)</span> <b id="val-fpr">4%</b></label>
            <input type="range" id="sl-fpr" min="0.1" max="20" step="0.1" value="4" oninput="app.manualUpdate()">
        </div>
    </div>
</header>

<div class="main-container">
    <div class="visual-panel">
        <div class="legend-box">
            <div style="margin-bottom:6px"><span class="dot" style="background:var(--true-pos)"></span> æœ‰ç—… (çœŸé˜³) <b id="txt-tp" style="float:right"></b></div>
            <div style="margin-bottom:6px"><span class="dot" style="background:var(--false-pos)"></span> è¯¯è¯Š (å‡é˜³) <b id="txt-fp" style="float:right"></b></div>
            <div style="margin-bottom:6px; color:#718096"><span class="dot" style="background:var(--true-neg)"></span> å¥åº· (çœŸé˜´) <span id="txt-tn" style="float:right"></span></div>
            <div style="color:#718096"><span class="dot" style="background:var(--false-neg)"></span> æ¼è¯Š (å‡é˜´) <span id="txt-fn" style="float:right"></span></div>
        </div>
        
        <button class="btn-view" onclick="app.toggleSort()">ğŸ” åˆ‡æ¢: æ•£ä¹± / æ’åº</button>
        
        <div class="canvas-wrapper" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>

    <div class="stats-panel">
        <!-- æŸ±çŠ¶å›¾ -->
        <div class="card" style="flex: 1.2">
            <h3>ğŸ“Š é˜³æ€§äººç¾¤æˆåˆ†åˆ†æ</h3>
            <div class="chart-wrapper" id="bar-wrapper">
                <canvas id="barChart"></canvas>
            </div>
            <div class="result-box" style="margin-top:10px; background: #ebf8ff; border-color:#bee3f8;">
                <span class="res-ratio" id="txt-ratio-box" style="background:white; border:1px solid #90cdf4; color:#2b6cb0;">
                    1çœŸ : 8.4å‡
                </span>
                <span style="font-size:0.8rem; color:#2c5282;">â† æ¯æ‰¾å‡º1ä¸ªç—…äººï¼Œéœ€è¯¯æŠ“çš„äººæ•°</span>
            </div>
        </div>

        <!-- æ›²çº¿å›¾ -->
        <div class="card" style="flex: 1">
            <h3>ğŸ“ˆ æ¦‚ç‡è¶‹åŠ¿ (P(C|A) vs å…ˆéªŒ)</h3>
            <div class="chart-wrapper" id="line-wrapper">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <div class="card" style="flex: 0.8; justify-content: center; border-left: 5px solid #e53e3e;">
            <h3 style="border:none; margin:0; text-align: center; color:#e53e3e;">æœ€ç»ˆè®¡ç®—ç»“è®º</h3>
            <div class="result-box" style="border:none; background:transparent;">
                <div class="res-prob">
                    <span class="res-val" id="txt-final-prob">0.00%</span>
                    <span class="res-label">P(C|A) ç¡®è¯Šæ¦‚ç‡</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="error-global"></div>

<script>
const app = {
    // æ ¸å¿ƒé…ç½®
    totalN: 10000,
    particles: [],
    isSorted: false,
    width: 0, 
    height: 0,
    ctx: null,
    
    // å›¾è¡¨å®ä¾‹
    chartBar: null,
    chartLine: null,

    // é¢œè‰²ç³»ç»Ÿ
    colors: { tp: '#f56565', fp: '#4fd1c5', tn: '#cbd5e0', fn: '#2d3748' },

    // é¢„è®¾åœºæ™¯åº“
    scenarios: [
        { 
            name: "ğŸ§ª ç½•è§ç—…ç­›æŸ¥", 
            desc: "å‘ç—…ç‡æä½ï¼Œè¯¯è¯Šé€ æˆçš„å‡é˜³æ€§è¿œå¤šäºçœŸé˜³æ€§ã€‚",
            pC_range: [0.1, 0.8], sens_range: [95, 99], fpr_range: [2, 5] 
        },
        { 
            name: "ğŸ§¬ ç²¾å¯†ä»ªå™¨æ£€æµ‹", 
            desc: "ç²¾åº¦æé«˜(è¯¯è¯Š<0.5%)ï¼Œç»“æœé«˜åº¦å¯ä¿¡ã€‚",
            pC_range: [0.2, 1.0], sens_range: [99, 99.9], fpr_range: [0.1, 0.5] 
        },
        { 
            name: "ğŸ¦  ç—…æ¯’æµè¡Œå­£", 
            desc: "å‘ç—…ç‡é«˜(>10%)ï¼Œæ£€æµ‹çš„å¯ä¿¡åº¦è‡ªç„¶æå‡ã€‚",
            pC_range: [10, 15], sens_range: [85, 95], fpr_range: [3, 8] 
        },
        { 
            name: "ğŸšï¸ å»‰ä»·è¯•çº¸åˆç­›", 
            desc: "çµæ•åº¦ä½ã€è¯¯è¯Šç‡é«˜ã€‚åªèƒ½ç”¨äºç²—æŸ¥ã€‚",
            pC_range: [1, 3], sens_range: [70, 85], fpr_range: [10, 20] 
        }
    ],

    init: function() {
        try {
            this.initCanvas();
            this.initParticles();
            this.initCharts(); // å°è¯•åˆå§‹åŒ–
            
            // å»¶æ—¶ä¸€ç‚¹å†è·‘ç¬¬ä¸€æ¬¡éšæœºï¼Œç¡®ä¿Canvaså¸ƒå±€å®Œæˆ
            setTimeout(() => this.randomScenario(), 100);
            
            this.animate();
        } catch(e) {
            console.error(e);
            document.getElementById('error-global').style.display = 'block';
            document.getElementById('error-global').innerText = "ç¨‹åºåˆå§‹åŒ–å¼‚å¸¸: " + e.message;
        }
        
        window.addEventListener('resize', () => { 
            this.initCanvas(); 
            this.recalcPositions();
        });
    },

    randomScenario: function() {
        const scene = this.scenarios[Math.floor(Math.random() * this.scenarios.length)];
        const rand = (min, max) => (Math.random() * (max - min) + min).toFixed(1);
        
        document.getElementById('sl-pC').value = rand(...scene.pC_range);
        document.getElementById('sl-sens').value = rand(...scene.sens_range);
        document.getElementById('sl-fpr').value = rand(...scene.fpr_range);

        this.showToast(scene.name, scene.desc);
        this.updateData();
    },

    showToast: function(title, desc) {
        const t = document.getElementById('scenario-toast');
        t.innerHTML = `<strong>${title}</strong><br><span style="opacity:0.9">${desc}</span>`;
        t.style.opacity = 1;
        t.style.top = "80px";
        if(this.toastTimer) clearTimeout(this.toastTimer);
        this.toastTimer = setTimeout(() => { t.style.opacity = 0; t.style.top = "65px"; }, 4000);
    },

    manualUpdate: function() {
        this.updateData();
    },

    initCanvas: function() {
        const c = document.getElementById('canvasContainer');
        const cvs = document.getElementById('mainCanvas');
        this.width = c.clientWidth;
        this.height = c.clientHeight;
        const dpr = window.devicePixelRatio || 1;
        cvs.width = this.width * dpr;
        cvs.height = this.height * dpr;
        this.ctx = cvs.getContext('2d');
        this.ctx.scale(dpr, dpr);
    },

    initParticles: function() {
        this.particles = Array.from({length: this.totalN}, () => ({
            x: Math.random() * this.width,
            y: Math.random() * this.height,
            tx: 0, ty: 0,
            type: 'tn',
            speed: 0.1 + Math.random() * 0.15
        }));
    },

    updateData: function() {
        // è¯»å–
        const pC_val = parseFloat(document.getElementById('sl-pC').value);
        const sens_val = parseFloat(document.getElementById('sl-sens').value);
        const fpr_val = parseFloat(document.getElementById('sl-fpr').value);

        const pC = pC_val / 100;
        const sens = sens_val / 100;
        const fpr = fpr_val / 100;

        // UI
        document.getElementById('val-pC').innerText = pC_val.toFixed(1) + "%";
        document.getElementById('val-sens').innerText = sens_val.toFixed(1) + "%";
        document.getElementById('val-fpr').innerText = fpr_val.toFixed(1) + "%";

        // è®¡ç®—
        const nTP = Math.round(this.totalN * pC * sens);
        const nFN = Math.round(this.totalN * pC * (1-sens));
        const nFP = Math.round(this.totalN * (1-pC) * fpr);
        const nTN = this.totalN - nTP - nFN - nFP;

        // åˆ†é…ç²’å­
        let idx = 0;
        const setType = (n, type) => { for(let i=0; i<n; i++) if(idx < this.totalN) this.particles[idx++].type = type; };
        
        setType(nTP, 'tp');
        setType(nFP, 'fp');
        setType(nFN, 'fn');
        setType(nTN, 'tn');
        while(idx < this.totalN) this.particles[idx++].type = 'tn';

        // æ›´æ–°æ•°å­—
        document.getElementById('txt-tp').innerText = nTP;
        document.getElementById('txt-fp').innerText = nFP;
        document.getElementById('txt-fn').innerText = nFN;
        document.getElementById('txt-tn').innerText = nTN;

        const totalPos = nTP + nFP;
        const finalProb = totalPos > 0 ? (nTP / totalPos * 100) : 0;
        const ratio = nTP > 0 ? (nFP / nTP).toFixed(1) : "-";

        document.getElementById('txt-final-prob').innerText = finalProb.toFixed(2) + "%";
        document.getElementById('txt-ratio-box').innerText = `1çœŸ : ${ratio}å‡`;

        this.recalcPositions();
        
        // å°è¯•æ›´æ–°å›¾è¡¨ï¼Œå¦‚æœå®ä¾‹å­˜åœ¨
        if(this.chartBar && this.chartLine) {
            this.updateCharts(nTP, nFP, pC_val, sens, fpr, finalProb);
        }
    },

    recalcPositions: function() {
        if(!this.isSorted) {
            this.particles.forEach(p => {
                p.tx = Math.random() * this.width;
                p.ty = Math.random() * this.height;
            });
        } else {
            let iTP=0, iFP=0, iRest=0;
            const cx = this.width / 2;
            const cy = this.height / 2;
            
            // ç®€å•Gridå¸ƒå±€
            this.particles.forEach(p => {
                if(p.type === 'tp') {
                    const col = iTP % 20; const row = Math.floor(iTP / 20);
                    p.tx = cx - 15 - (col * 5); 
                    p.ty = cy - 50 + (row * 5);
                    iTP++;
                } else if(p.type === 'fp') {
                    const col = iFP % 20; const row = Math.floor(iFP / 20);
                    p.tx = cx + 15 + (col * 5); 
                    p.ty = cy - 50 + (row * 5);
                    iFP++;
                } else {
                    const cols = Math.floor(this.width / 3.5);
                    p.tx = (iRest % cols) * 3.5;
                    p.ty = this.height - 5 - (Math.floor(iRest / cols) * 3.5);
                    iRest++;
                }
            });
        }
    },

    toggleSort: function() {
        this.isSorted = !this.isSorted;
        this.recalcPositions();
    },

    animate: function() {
        const { ctx, width, height } = this;
        ctx.clearRect(0, 0, width, height);

        for(let i=0; i<this.totalN; i++) {
            const p = this.particles[i];
            const dx = p.tx - p.x;
            const dy = p.ty - p.y;
            
            if((dx > 0.1 || dx < -0.1) || (dy > 0.1 || dy < -0.1)) {
                p.x += dx * 0.15; 
                p.y += dy * 0.15;
            }
            ctx.fillStyle = this.colors[p.type];
            ctx.beginPath();
            const size = (p.type==='tp'||p.type==='fp') ? 2.5 : 1.5;
            ctx.arc(p.x, p.y, size, 0, 6.28);
            ctx.fill();
        }
        requestAnimationFrame(() => this.animate());
    },

    initCharts: function() {
        // å®‰å…¨æ£€æµ‹ï¼šå¦‚æœCDNæŒ‚äº†ï¼ŒChatæ˜¯undefined
        if(typeof Chart === 'undefined') {
            const errHTML = `<div class="chart-error">âš ï¸ å›¾è¡¨ç»„ä»¶è¿æ¥è¶…æ—¶<br>Staticfile CDN å“åº”æ…¢ï¼Œè¯·åˆ·æ–°é‡è¯•</div>`;
            document.getElementById('bar-wrapper').innerHTML = errHTML;
            document.getElementById('line-wrapper').innerHTML = errHTML;
            return;
        }

        const ctxBar = document.getElementById('barChart').getContext('2d');
        this.chartBar = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['æœ‰ç—…(çœŸ)', 'è¯¯è¯Š(å‡)'],
                datasets: [{ label: 'äººæ•°', data:[0,0], backgroundColor:[this.colors.tp, this.colors.fp], borderRadius:5 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: false },
                scales: { y: { beginAtZero: true, grid: { display: false } } }
            }
        });

        const ctxLine = document.getElementById('lineChart').getContext('2d');
        this.chartLine = new Chart(ctxLine, {
            type: 'line',
            data: {
                datasets: [
                    { label:'P(C|A)', data:[], borderColor:this.colors.tp, borderWidth:2, pointRadius:0, tension:0.3 },
                    { label:'Current', data:[], pointBackgroundColor: this.colors.tp, pointRadius:5, showLine:false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: false },
                scales: { 
                    x: { type:'linear', min:0, max:50, title:{display:true, text:'å…ˆéªŒ P(C)%'} },
                    y: { min:0, max:100 }
                }
            }
        });
    },

    updateCharts: function(tp, fp, currPC, sens, fpr, prob) {
        // Bar
        this.chartBar.data.datasets[0].data = [tp, fp];
        this.chartBar.update();

        // Line
        const data = [];
        for(let x=0.1; x<=50; x+=1) {
            const pr = x/100;
            const y = (sens * pr) / ((sens*pr) + (fpr*(1-pr))) * 100;
            data.push({x:x, y:y});
        }
        this.chartLine.data.datasets[0].data = data;
        this.chartLine.data.datasets[1].data = [{x: currPC, y: prob}];
        this.chartLine.update('none');
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
