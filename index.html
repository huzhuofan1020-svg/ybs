<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´å¶æ–¯å¯è§†åŒ–ï¼šå…¨å±è‡ªé€‚åº”ç‰ˆ</title>
    <!-- ä½¿ç”¨å›½å†…ç¨³å®š CDN -->
    <script src="https://cdn.staticfile.org/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --bg: #f4f6f8;
            --panel: #ffffff;
            --primary: #3182ce;
            --accent: #e53e3e;
            --border: #e2e8f0;
            --text-main: #2d3748;
            --text-sub: #718096;
            
            --c-tp: #f56565; /* çœŸé˜³ çº¢ */
            --c-fp: #4fd1c5; /* å‡é˜³ é’ */
            --c-tn: #cbd5e0; /* çœŸé˜´ ç° */
            --c-fn: #2d3748; /* å‡é˜´ é»‘ */
        }

        * { box-sizing: border-box; }

        /* --- å¸ƒå±€æ ¸å¿ƒï¼šå¼ºåˆ¶ä¸€å± --- */
        body {
            margin: 0; padding: 0;
            background: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, "Microsoft YaHei", sans-serif;
            height: 100vh;      /* å æ»¡è§†å£é«˜åº¦ */
            width: 100vw;       /* å æ»¡è§†å£å®½åº¦ */
            overflow: hidden;   /* ç¦æ­¢å‡ºç°æ»šåŠ¨æ¡ */
            display: flex;
            flex-direction: column;
        }

        /* 1. é¡¶éƒ¨ Header (é«˜åº¦å›ºå®šä½†ç´§å‡‘) */
        header {
            flex: 0 0 56px; /* å›ºå®šé«˜åº¦ */
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            z-index: 10;
        }

        /* æ ‡é¢˜åŒº */
        .h-left h1 { margin: 0; font-size: 1.1rem; line-height: 1; }
        .h-left small { font-size: 0.7rem; color: var(--text-sub); }

        /* æ§ä»¶åŒº (å¼¹æ€§å¸ƒå±€ï¼Œå±å¹•çª„æ—¶è‡ªåŠ¨å‹ç¼©é—´è·) */
        .controls { display: flex; gap: 2vw; align-items: center; } /* ä½¿ç”¨ vw å•ä½è®©é—´è·éšå±å¹•å˜ */
        
        /* æ»‘å—ç»„ä»¶ä¼˜åŒ– */
        .slider-box { display: flex; flex-direction: column; width: 140px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 600; color: var(--text-sub); margin-bottom: 2px; }
        .slider-box input { 
            height: 4px; border-radius: 2px; -webkit-appearance: none; background: #e2e8f0; cursor: pointer; width: 100%;
        }
        .slider-box input::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; margin-top: -5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-rand {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff;
            border: none; padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; cursor: pointer;
            white-space: nowrap; transition: 0.2s; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25);
        }
        .btn-rand:hover { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(102, 126, 234, 0.35); }

        /* 2. ä¸»å®¹å™¨ (è‡ªé€‚åº”å‰©ä½™ç©ºé—´) */
        main {
            flex: 1;                /* å æ® Header å‰©ä¸‹çš„æ‰€æœ‰ç©ºé—´ */
            display: flex;          /* å·¦å³åˆ†æ  */
            gap: 12px;
            padding: 12px;
            overflow: hidden;       /* å†…éƒ¨ç¦æ­¢æº¢å‡º */
            position: relative;
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }

        /* å·¦é¢æ¿ï¼šæ•£ç‚¹å›¾ (æƒé‡é«˜ï¼Œå ä¸»è¦ç©ºé—´) */
        #visual-panel {
            flex: 6; /* 60% å®½ */
            position: relative;
        }

        /* æ ¸å¿ƒï¼šCanvas å®¹å™¨ */
        .canvas-container {
            flex: 1;            /* è‡ªåŠ¨å¡«æ»¡ card å‰©ä½™é«˜åº¦ */
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;   /* è£å‰ªè¶…å‡ºéƒ¨åˆ† */
        }
        canvas { display: block; outline: none; } /* å»é™¤é»˜è®¤è¾¹è· */

        /* æµ®åŠ¨å›¾ä¾‹ */
        .legend {
            position: absolute; top: 12px; left: 12px; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(4px);
            padding: 10px; border-radius: 6px; border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-size: 12px;
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€ï¼Œä¸å½±å“Canvasäº¤äº’ */
        }
        .legend-row { display: flex; align-items: center; margin-bottom: 4px; justify-content: space-between; gap: 10px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        .view-toggle {
            position: absolute; top: 12px; right: 12px;
            background: #fff; border: 1px solid #cbd5e0; color: #4a5568;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;
            z-index: 5; transition: 0.2s;
        }
        .view-toggle:hover { border-color: var(--primary); color: var(--primary); }

        /* å³é¢æ¿ï¼šç»Ÿè®¡å›¾è¡¨ (æƒé‡ä½ï¼Œå‚ç›´æ’åˆ—) */
        #stats-panel {
            flex: 4; /* 40% å®½ */
            display: flex; flex-direction: column; gap: 10px;
        }

        /* å›¾è¡¨å¡ç‰‡ */
        .chart-card {
            flex: 1; /* å¹³åˆ†å‚ç›´ç©ºé—´ */
            min-height: 0; /* å…³é”®CSSï¼šå…è®¸ flex item å‹ç¼©å†…å®¹ */
            padding: 10px;
            position: relative;
        }
        .chart-card h3 {
            margin: 0 0 5px 0; font-size: 0.85rem; color: #4a5568; 
            border-left: 3px solid var(--primary); padding-left: 8px;
        }
        
        /* è¿™é‡Œçš„ flex:1 min-height:0 ä¿è¯äº†å›¾è¡¨å¯ä»¥éšå±å¹•å˜æ‰ */
        .chart-body { flex: 1; position: relative; width: 100%; min-height: 0; }

        /* ç»“è®ºåŒº (ç¨å¾®çŸ®ä¸€ç‚¹) */
        .result-card {
            flex: 0 0 auto; /* é«˜åº¦ç”±å†…å®¹å†³å®šï¼Œä¸æ‹‰ä¼¸ */
            background: #fff5f5; border-color: #feb2b2;
            padding: 12px; text-align: center;
        }
        .result-text { font-size: 0.75rem; color: #744210; margin-bottom: 2px; }
        .result-big { font-size: 1.8rem; font-weight: 800; color: #e53e3e; line-height: 1; }

        /* Toast æç¤º */
        #toast {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(26, 32, 44, 0.9); color: white; padding: 8px 20px;
            border-radius: 20px; font-size: 0.85rem; opacity: 0; transition: 0.3s;
            pointer-events: none; z-index: 99;
        }

    </style>
</head>
<body>

<header>
    <div class="h-left">
        <h1>è´å¶æ–¯å¯è§†åŒ–</h1>
        <small>N=10,000 | 100%å…¨å±è‡ªé€‚åº”</small>
    </div>
    
    <div class="controls">
        <button class="btn-rand" onclick="app.randomScene()">ğŸ² éšæœºæ¡ˆä¾‹</button>
        
        <div class="slider-box">
            <div class="slider-label"><span>å‘ç—…ç‡ P(C)</span><span id="lbl-pC">0.5%</span></div>
            <input type="range" id="inp-pC" min="0.1" max="50" step="0.1" value="0.5">
        </div>
        <div class="slider-box">
            <div class="slider-label"><span>çµæ•åº¦ P(A|C)</span><span id="lbl-sens">95%</span></div>
            <input type="range" id="inp-sens" min="50" max="99.9" step="0.1" value="95">
        </div>
        <div class="slider-box">
            <div class="slider-label"><span>è¯¯è¯Šç‡ P(A|CÌ…)</span><span id="lbl-fpr">4%</span></div>
            <input type="range" id="inp-fpr" min="0.1" max="20" step="0.1" value="4">
        </div>
    </div>
</header>

<div id="toast">åœºæ™¯åŠ è½½ä¸­...</div>

<main>
    <!-- å·¦ï¼šå¯è§†åŒ–é¢æ¿ -->
    <div id="visual-panel" class="card">
        <div class="legend">
            <div class="legend-row"><div style="display:flex;align-items:center"><div class="dot" style="background:var(--c-tp)"></div>çœŸé˜³</div><b id="txt-tp"></b></div>
            <div class="legend-row"><div style="display:flex;align-items:center"><div class="dot" style="background:var(--c-fp)"></div>å‡é˜³</div><b id="txt-fp"></b></div>
            <div class="legend-row"><div style="display:flex;align-items:center"><div class="dot" style="background:var(--c-tn)"></div>çœŸé˜´</div><span id="txt-tn"></span></div>
            <div class="legend-row"><div style="display:flex;align-items:center"><div class="dot" style="background:var(--c-fn)"></div>å‡é˜´</div><span id="txt-fn"></span></div>
        </div>
        
        <button class="view-toggle" onclick="app.toggleSort()">ğŸ” æ’åº/æ‰“ä¹±</button>
        
        <div class="canvas-container" id="canvas-wrapper">
            <canvas id="vizCanvas"></canvas>
        </div>
    </div>

    <!-- å³ï¼šç»Ÿè®¡é¢æ¿ -->
    <div id="stats-panel">
        <div class="card chart-card">
            <h3>ğŸ“Š é˜³æ€§æˆåˆ†åˆ†æ (çœŸ vs å‡)</h3>
            <div class="chart-body">
                <canvas id="barChart"></canvas>
            </div>
            <div style="font-size:0.75rem; text-align:center; padding-top:4px; color:var(--primary);">
                æ¯æŠ“åˆ° 1 ä¸ªçœŸç—…äººï¼ŒåŒæ—¶è¯¯æŠ“ <b id="txt-ratio">-</b> äºº
            </div>
        </div>

        <div class="card chart-card">
            <h3>ğŸ“ˆ è´å¶æ–¯æ›²çº¿ (æ¦‚ç‡ vs å‘ç—…ç‡)</h3>
            <div class="chart-body">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <div class="card result-card">
            <div class="result-text">é€†æ¦‚ç‡ P(C|A) è®¡ç®—ç»“æœ</div>
            <div class="result-big" id="txt-prob">0.00%</div>
            <div class="result-text" style="color:#718096">æ£€æµ‹é˜³æ€§ï¼Œä½†çœŸæœ‰ç—…çš„æ¦‚ç‡</div>
        </div>
    </div>
</main>

<script>
const app = {
    // åŸºç¡€é…ç½®
    totalN: 10000,
    particles: [],
    isSorted: false,
    width: 0, height: 0,
    colors: { tp: '#f56565', fp: '#4fd1c5', tn: '#cbd5e0', fn: '#2d3748' },
    
    // é¢„è®¾åœºæ™¯
    scenes: [
        { n: "ç½•è§ç—…ç­›æŸ¥", d: "ä½å‘ç—…ç‡ï¼Œè¯¯è¯Šæ˜¯æœ€å¤§å™ªéŸ³", p:[0.1, 0.8], s:[95, 99], f:[2, 5] },
        { n: "ç²¾å¯†ä»ªå™¨", d: "è¯¯è¯Šç‡æä½ï¼Œç»“æœå¯é ", p:[0.2, 1.0], s:[99, 99.9], f:[0.1, 0.5] },
        { n: "å¤§è§„æ¨¡æµè¡Œ", d: "å‘ç—…ç‡é«˜ï¼Œæ£€æµ‹æ›´å®¹æ˜“å‡†", p:[10, 15], s:[85, 95], f:[3, 8] },
        { n: "ç²—ç•¥è¯•çº¸", d: "ä¾¿å®œä½†è¯¯è¯Šå¤šï¼Œä»…ä¾›å‚è€ƒ", p:[1, 3], s:[70, 85], f:[10, 20] }
    ],

    init() {
        // DOM Elements
        this.dom = {
            pC: document.getElementById('inp-pC'),
            sens: document.getElementById('inp-sens'),
            fpr: document.getElementById('inp-fpr'),
            wrapper: document.getElementById('canvas-wrapper'),
            cvs: document.getElementById('vizCanvas')
        };
        
        // Listeners
        [this.dom.pC, this.dom.sens, this.dom.fpr].forEach(el => 
            el.addEventListener('input', () => this.update(true))
        );

        // åˆå§‹åŒ–
        this.initCanvasObserver(); // å…³é”®ï¼šå¯åŠ¨å°ºå¯¸ç›‘å¬
        this.initParticles();
        this.initCharts();
        
        // ç¬¬ä¸€æ¬¡è¿è¡Œ
        setTimeout(() => this.randomScene(), 100);
        this.loop();
    },

    // --- å…³é”®ï¼šä½¿ç”¨ ResizeObserver å®ç°ç”»å¸ƒè‡ªåŠ¨å¸é™„ ---
    initCanvasObserver() {
        this.resize(); // é¦–æ¬¡æ‰§è¡Œ
        
        // ç›‘å¬çˆ¶å®¹å™¨å¤§å°å˜åŒ–
        const observer = new ResizeObserver(() => {
            this.resize();
            // é‡ç½®ä½ç½®ï¼Œé˜²æ­¢ç‚¹è·‘å‡ºå±å¹•å¤–
            if(this.particles.length > 0) this.recalcTargets();
        });
        observer.observe(this.dom.wrapper);
    },

    resize() {
        // è·å–å®¹å™¨å®æ—¶å®½é«˜
        const w = this.dom.wrapper.clientWidth;
        const h = this.dom.wrapper.clientHeight;
        
        this.width = w;
        this.height = h;

        // è®¾ç½® canvas åˆ†è¾¨ç‡ (é€‚åº”é«˜åˆ†å±)
        const dpr = window.devicePixelRatio || 1;
        this.dom.cvs.width = w * dpr;
        this.dom.cvs.height = h * dpr;
        
        this.ctx = this.dom.cvs.getContext('2d');
        this.ctx.scale(dpr, dpr);
    },

    randomScene() {
        const s = this.scenes[Math.floor(Math.random() * this.scenes.length)];
        const rnd = (r) => (Math.random() * (r[1] - r[0]) + r[0]).toFixed(1);
        
        this.dom.pC.value = rnd(s.p);
        this.dom.sens.value = rnd(s.s);
        this.dom.fpr.value = rnd(s.f);
        
        this.showToast(s.n, s.d);
        this.update(true);
    },

    showToast(title, desc) {
        const t = document.getElementById('toast');
        t.innerHTML = `<strong>${title}</strong>: ${desc}`;
        t.style.opacity = 1;
        t.style.top = "70px";
        if(this.tm) clearTimeout(this.tm);
        this.tm = setTimeout(() => { t.style.opacity = 0; t.style.top = "60px"; }, 3000);
    },

    initParticles() {
        this.particles = new Float32Array(this.totalN * 5); // [x, y, tx, ty, type] ä¼˜åŒ–æ€§èƒ½
        // åˆå§‹åŒ–èµ‹å€¼
        for(let i=0; i<this.totalN; i++) {
            const off = i*5;
            this.particles[off] = Math.random() * this.width;   // x
            this.particles[off+1] = Math.random() * this.height; // y
            this.particles[off+4] = 2; // default tn (2)
        }
    },

    update(updateCharts = false) {
        // è¯»å–
        const pC = parseFloat(this.dom.pC.value) / 100;
        const sens = parseFloat(this.dom.sens.value) / 100;
        const fpr = parseFloat(this.dom.fpr.value) / 100;

        // æ›´æ–° Label
        document.getElementById('lbl-pC').innerText = (pC*100).toFixed(1) + "%";
        document.getElementById('lbl-sens').innerText = (sens*100).toFixed(1) + "%";
        document.getElementById('lbl-fpr').innerText = (fpr*100).toFixed(1) + "%";

        // è®¡ç®—äººæ•°
        const nTP = Math.round(this.totalN * pC * sens);
        const nFN = Math.round(this.totalN * pC * (1-sens));
        const nFP = Math.round(this.totalN * (1-pC) * fpr);
        const nTN = this.totalN - nTP - nFN - nFP;

        // åˆ†é…ç²’å­ç±»å‹: 0:tp, 1:fp, 2:tn, 3:fn
        let idx = 0;
        const fill = (n, t) => {
            for(let i=0; i<n; i++) {
                if(idx < this.totalN) this.particles[idx*5 + 4] = t;
                idx++;
            }
        };
        fill(nTP, 0); fill(nFP, 1); fill(nTN, 2); fill(nFN, 3);
        while(idx < this.totalN) { this.particles[idx*5 + 4] = 2; idx++; }

        // UI æ›´æ–°
        document.getElementById('txt-tp').innerText = nTP;
        document.getElementById('txt-fp').innerText = nFP;
        document.getElementById('txt-tn').innerText = nTN;
        document.getElementById('txt-fn').innerText = nFN;

        const totalPos = nTP + nFP;
        const finalProb = totalPos > 0 ? (nTP / totalPos * 100) : 0;
        const ratio = nTP > 0 ? (nFP/nTP).toFixed(1) : "-";

        document.getElementById('txt-prob').innerText = finalProb.toFixed(2) + "%";
        document.getElementById('txt-ratio').innerText = ratio;

        this.recalcTargets();
        
        if(updateCharts && this.barChart) this.updateCharts(nTP, nFP, (pC*100), sens, fpr, finalProb);
    },

    recalcTargets() {
        const w = this.width; const h = this.height;
        const cx = w/2; const cy = h/2;
        
        if(!this.isSorted) {
            // æ•£ä¹±æ¨¡å¼ï¼šé‡æ–°éšæœºåˆ†å¸ƒ
            for(let i=0; i<this.totalN; i++) {
                const off = i*5;
                this.particles[off+2] = Math.random() * w; // tx
                this.particles[off+3] = Math.random() * h; // ty
            }
        } else {
            // æ’åºæ¨¡å¼ï¼šåŠ¨æ€è®¡ç®—æ ¼å­
            let iTP=0, iFP=0, iRest=0;
            // æ ¼å­é—´è·è‡ªé€‚åº”
            const gap = 4;
            
            for(let i=0; i<this.totalN; i++) {
                const off = i*5;
                const type = this.particles[off+4];
                
                if(type === 0) { // TP (Red) -> Left Center
                    const c = iTP % 25; const r = Math.floor(iTP / 25);
                    this.particles[off+2] = cx - 15 - (c*gap);
                    this.particles[off+3] = cy - 50 + (r*gap);
                    iTP++;
                } else if(type === 1) { // FP (Green) -> Right Center
                    const c = iFP % 25; const r = Math.floor(iFP / 25);
                    this.particles[off+2] = cx + 15 + (c*gap);
                    this.particles[off+3] = cy - 50 + (r*gap);
                    iFP++;
                } else { // Others -> Bottom fill
                    // è®©æ— å…³çš„ç‚¹å°½å¯èƒ½é“ºæ»¡åº•éƒ¨ï¼Œä¸æ‹¥æŒ¤
                    const cols = Math.floor(w / 3.5); 
                    this.particles[off+2] = (iRest % cols) * 3.5;
                    this.particles[off+3] = h - 5 - (Math.floor(iRest / cols) * 3.5);
                    iRest++;
                }
            }
        }
    },

    toggleSort() {
        this.isSorted = !this.isSorted;
        this.recalcTargets();
    },

    loop() {
        // æ¸²æŸ“å¾ªç¯
        const { ctx, width, height } = this;
        ctx.clearRect(0, 0, width, height);

        // Map types to color strings
        const cMap = [this.colors.tp, this.colors.fp, this.colors.tn, this.colors.fn];

        // æ‰¹é‡ç»˜åˆ¶ï¼šä¸ºäº†æ€§èƒ½ï¼Œå¯ä»¥æŒ‰é¢œè‰²åˆ†æ‰¹ç”»ï¼Œæˆ–è€…ç›´æ¥éå†ç”»
        // è¿™é‡Œ N=10000 ç›´æ¥ç”»ä¹Ÿå¾ˆå¿«
        for(let i=0; i<this.totalN; i++) {
            const off = i*5;
            let x = this.particles[off];
            let y = this.particles[off+1];
            const tx = this.particles[off+2];
            const ty = this.particles[off+3];
            
            // Lerp move
            const dx = tx - x; const dy = ty - y;
            if(Math.abs(dx)>0.1 || Math.abs(dy)>0.1) {
                x += dx * 0.15;
                y += dy * 0.15;
                this.particles[off] = x;
                this.particles[off+1] = y;
            }

            // Draw
            ctx.fillStyle = cMap[this.particles[off+4]];
            ctx.beginPath();
            // åªæœ‰ TP(0) å’Œ FP(1) ç”»å¤§ä¸€ç‚¹
            const t = this.particles[off+4];
            const r = (t===0||t===1) ? 2.5 : 1.5;
            ctx.arc(x, y, r, 0, 6.28);
            ctx.fill();
        }
        requestAnimationFrame(() => this.loop());
    },

    initCharts() {
        if(typeof Chart === 'undefined') return; // fail safe

        // Bar Config
        this.barChart = new Chart(document.getElementById('barChart').getContext('2d'), {
            type: 'bar',
            data: { labels: ['çœŸé˜³æ€§', 'å‡é˜³æ€§'], datasets: [{ data:[0,0], backgroundColor:[this.colors.tp, this.colors.fp], borderRadius:4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins:{legend:false}, scales:{y:{beginAtZero:true, grid:{display:false}}} }
        });

        // Line Config
        this.lineChart = new Chart(document.getElementById('lineChart').getContext('2d'), {
            type: 'line',
            data: { datasets: [{ borderColor:this.colors.tp, borderWidth:2, pointRadius:0, tension:0.4, data:[] }, { pointBackgroundColor:this.colors.tp, pointRadius:4, showLine:false, data:[] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins:{legend:false}, scales:{x:{type:'linear',min:0,max:50,ticks:{maxTicksLimit:5}}, y:{min:0,max:100,ticks:{stepSize:25}}} }
        });
    },

    updateCharts(tp, fp, currPC, sens, fpr, prob) {
        // Bar
        this.barChart.data.datasets[0].data = [tp, fp];
        this.barChart.update();

        // Line (lazy gen data)
        const data = [];
        for(let x=0.1; x<=50; x+=2) { // é™ä½é‡‡æ ·ç‡æé«˜æ€§èƒ½
            const pr = x/100;
            const y = (sens*pr)/((sens*pr)+(fpr*(1-pr))) * 100;
            data.push({x, y});
        }
        this.lineChart.data.datasets[0].data = data;
        this.lineChart.data.datasets[1].data = [{x:currPC, y:prob}];
        this.lineChart.update('none');
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
